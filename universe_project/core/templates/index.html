<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Lista de Clientes</title>
    <style>
        body {
            font-family: Arial;
            padding: 40px;
            /* Top-to-bottom blue gradient: dark blue -> blue */
            background: linear-gradient(180deg, #031028 0%, #0b3b5a 35%, #1b4f8a 100%);
            color: #fff;
        }

        /* ======== TABELA DE CLIENTES ======== */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            text-align: left;
        }
        tr:hover {
            background: #f1f1f1;
        }
        /* Botões na Tabela e Cadastro */
        button.button, a.button, #abrirModalCadastrar {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
            border: none;
            cursor: pointer;
            margin-right: 5px; /* Espaçamento entre os botões */
        }
        button.button:hover, a.button:hover {
            background-color: #0056b3;
        }
        button.delete, a.delete {
            background-color: #dc3545;
        }
        button.delete:hover, a.delete:hover {
            background-color: #b02a37;
        }

        /* ======== BOTÃO DE CADASTRO ======== */
        #abrirModalCadastrar {
            background-color: #28a745;
            padding: 10px 20px;
            margin: 15px 0;
            font-size: 16px;
        }
        #abrirModalCadastrar:hover {
            background-color: #218838;
        }

        /* ======== ESTILOS DO MODAL GERAL ======== */
        .modal {
            display: none; /* invisível inicialmente */
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); /* fundo escuro */
            z-index: 10;
        }
        .modal-content {
            background: white;
            width: 400px;
            margin: 10% auto; /* centraliza vertical e horizontal */
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            text-align: left;
        }
        .close {
            float: right;
            font-size: 22px;
            cursor: pointer;
            color: #666;
        }
        .close:hover {
            color: red;
        }
        
        /* ======== ESTILOS DO FORMULÁRIO DENTRO DO MODAL ======== */
        #clienteForm label {
            display: block;
            margin-top: 12px;
            font-weight: 500; /* slightly lighter */
            font-size: 14px;
            margin-bottom: 6px;
        }
        /* Estilo para todos os inputs/widgets gerados pelo Django */
        #clienteForm input, #clienteForm select, #clienteForm textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        /* Estilo para a lista de erros do Django */
        .errorlist {
            color: #dc3545;
            list-style: none;
            padding-left: 0;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 13px;
        }
        /* Estilos dos botões no rodapé do modal */
        .botoes {
            text-align: right; 
            margin-top: 15px;
        }
        .botoes button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            margin-left: 5px;
            cursor: pointer;
        }

        /* Normalize appearance for all action buttons to match salvar/cancelar
           while preserving each button's original background color. */
        button, a.button, .button, .btn-alterar, .btn-excluir, #abrirModalCadastrar {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .salvar { background-color: #28a745; }
        .salvar:hover { background-color: #218838; }
        .cancelar { background-color: #6c757d; }
        .cancelar:hover { background-color: #5a6268; }

        /* Page title styling: centered and uppercase */
        .page-title {
            text-align: center;
            text-transform: uppercase;
            margin-top: 0;
            margin-bottom: 18px;
            color: #fff; /* stays white on the blue gradient */
            letter-spacing: 0.6px;
        }

        /* Ensure readable (black) text on white surfaces like tables and modals */
        table, table th, table td, .modal-content, .modal-content h3, .modal-content p, .modal-content label, .modal-content .form-group, .modal-content .errorlist {
            color: #111 !important;
        }

        /* Ensure form fields inside modals show black text on white background */
        .modal-content input, .modal-content select, .modal-content textarea {
            color: #111 !important;
        }

    /* Table headers uppercase */
    table th { text-transform: capitalize; }

    /* Hide server-rendered message list (we render via toasts/snackbars) */
    .messages { display: none; }

    /* Toast / snackbar centered at top — pastel blue background for all messages */
    .toast-container { position: fixed; top: 18px; left: 50%; transform: translateX(-50%); z-index: 9999; display:flex; flex-direction:column; gap:10px; align-items: center; }
    .toast { min-width: 260px; max-width: 760px; padding: 12px 16px; border-radius: 8px; color: #07263a; box-shadow: 0 8px 20px rgba(0,0,0,0.12); font-weight: 500; background: linear-gradient(90deg,#d7eefc,#bfe6ff); opacity:0; transform: translateY(-6px); transition: opacity 220ms, transform 220ms; text-align:center; }
    .toast.show { opacity: 1; transform: translateY(0); }

    /* Modal titles uppercase and centered */
    .modal-content h3 { text-transform: uppercase; text-align: center; }
    </style>
</head>
<body>

    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li class="message {{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    <!-- Título principal da página: centralizado e em maiúsculas.
        Eu coloquei a classe `page-title` para controlar o visual. -->
    <h2 class="page-title">Clientes Cadastrados</h2>

    <!-- Botão que abre o modal de cadastro. Simples e direto: ao clicar,
        o JavaScript prepara o formulário e mostra a janela. -->
    <button id="abrirModalCadastrar">Cadastrar novo cliente</button>

    <!-- Tabela que lista os clientes. Cada linha contém atributos
        data-* com os valores do cliente (usados para preencher o modal).
        Cabeçalhos usam capitalização para ficar legível. -->
    <table>
        <tr>
            <th>Conta</th>
            <th>Nome</th>
            <th>Email</th>
            <th>Telefone</th>
            <th>Saldo</th>
            <th>Ações</th>
        </tr>
        {% for cliente in clientes %}
        <tr>
            <td>{{ cliente.conta }}</td>
            <td>{{ cliente.nome }}</td>
            <td>{{ cliente.email }}</td>
            <td>{{ cliente.telefone }}</td>
            <td><span class="saldo-badge">R$ {{ cliente.saldo|floatformat:2 }}</span></td>
            <td>
                <button 
                    data-id="{{ cliente.id }}" 
                    data-nome="{{ cliente.nome|escapejs }}"
                    data-email="{{ cliente.email|escapejs }}"
                    data-telefone="{{ cliente.telefone|escapejs }}"
                    data-saldo="{{ cliente.saldo|floatformat:2|escapejs }}"
                    class="button btn-alterar"  
                >
                    Alterar
                </button>
                
                <!-- Botão Excluir: abre um pequeno modal de confirmação. -->
                <button 
                    data-id="{{ cliente.id }}"
                    data-nome="{{ cliente.nome|escapejs }}"
                    class="button delete btn-excluir"
                >
                    Excluir
                </button>
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="6">Nenhum cliente cadastrado.</td></tr>
        {% endfor %}  </table>

    <!-- Modal principal usado tanto para cadastro quanto para edição.
         - O conteúdo do formulário pode vir do servidor (renderizado com
           Django) ou ser preenchido pelo nosso template oculto (fallback).
         - O campo {% csrf_token %} sempre é necessário para segurança.
         - Em caso de erro de validação o servidor pode devolver o formulário
           com mensagens; o JS substitui o conteúdo do modal para mostrar
           esses erros sem recarregar a página. -->
    <div id="meuModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>

            <h3 id="modalTitle"></h3>
            <form method="POST" id="clienteForm" action="">
                {% csrf_token %}

                {# Aqui o Django renderiza os campos do formulário passado no contexto. #}
                {% for field in form %}
                <div class="form-group">
                    {{ field.label_tag }}
                    {{ field }}
                    {% if field.errors %}
                        <ul class="errorlist">
                            {% for error in field.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                {% endfor %}

                {{ form.non_field_errors }}

                <div class="botoes">
                    <!-- Botões padrão: cancelar volta ao estado anterior, salvar envia -->
                    <button type="button" class="cancelar" onclick="fecharModal()">Cancelar</button>
                    <button type="submit" class="salvar">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <div id="modalExcluir" class="modal">
        <div class="modal-content" style="width: 300px; text-align: center;">
            <span class="close" onclick="fecharModalExcluir()">&times;</span>
            <h3>Confirmar Exclusão</h3>
            <p>Tem certeza que deseja excluir o cliente <br><b><span id="nomeClienteExcluir"></span></b>?</p>
            
            <form method="POST" id="formExcluir" action="">
                {% csrf_token %}
                <div style="margin-top: 20px;">
                    <button type="button" class="cancelar" onclick="fecharModalExcluir()">Cancelar</button>
                    <button type="submit" class="button delete">Sim, Excluir</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Consolidated JS to handle modals, form submissions (AJAX) and toasts
        const modal = document.getElementById('meuModal');
        const form = document.getElementById('clienteForm');
        const modalTitle = document.getElementById('modalTitle');
        const modalExcluir = document.getElementById('modalExcluir');
        const formExcluir = document.getElementById('formExcluir');

        // URLs do Django (template tags)
        const urlCadastrar = "{% url 'cadastrar_cliente' %}";
        const urlEditarBase = "{% url 'editar_cliente' 0 %}";
        const urlExcluirBase = "{% url 'excluir_cliente' 0 %}";

        function ensureFormFields() {
            if (!form) return;
            if (!form.querySelector('input[name="nome"]')) {
                const tpl = document.getElementById('clienteFormTemplate');
                if (tpl) {
                    const inner = tpl.querySelector('#clienteFormTemplateInner');
                    if (inner) form.innerHTML = inner.innerHTML;
                }
            }
        }

        // Tradução simples para toasts: mapeia mensagens comuns (ou trechos) para português
        // Se quiser adicionar traduções específicas, inclua-as no objeto `translations`
        function translateMessage(msg) {
            if (!msg) return msg;
            const s = String(msg).trim();
            // map exato primeiro
            const translations = new Map([
                ['This field is required.', 'Este campo é obrigatório.'],
                ['Enter a valid email address.', 'Digite um endereço de e-mail válido.'],
                ['Enter a whole number.', 'Digite um número inteiro.'],
                ['Ensure this value is greater than or equal to 0.', 'Certifique-se de que o valor seja maior ou igual a 0.'],
                ['The form is invalid.', 'O formulário está inválido.'],
                ['Cliente cadastrado com sucesso!', 'Cliente cadastrado com sucesso!'],
                ['Cliente alterado com sucesso!', 'Cliente alterado com sucesso!'],
                ['Cliente excluído.', 'Cliente excluído.']
            ]);
            if (translations.has(s)) return translations.get(s);

            // regras por regex / trechos
            const rules = [
                { re: /this field is required\.?/i, out: 'Este campo é obrigatório.' },
                { re: /enter a valid email/i, out: 'Digite um endereço de e-mail válido.' },
                { re: /invalid|erro de validação|form is invalid/i, out: 'Há erros no formulário. Verifique os campos.' },
                { re: /success|sucesso/i, out: null } // manter parte que já está em PT
            ];
            for (const r of rules) {
                if (r.re.test(s)) {
                    if (r.out) return r.out;
                    break;
                }
            }

            // tentamos traduzir padrões com nomes (ex: Cliente "X" alterado com sucesso)
            const mNomeAlterado = s.match(/Cliente\s+"([^"]+)"\s+alterado\s+com\s+sucesso|Cliente\s+(.+)\s+alterado\s+com\s+sucesso/i);
            if (mNomeAlterado) return `Cliente alterado com sucesso!`;
            const mNomeCadastrado = s.match(/Cliente\s+cadastrado\s+com\s+sucesso|Cliente\s+(.+)\s+cadastrado\s+com\s+sucesso/i);
            if (mNomeCadastrado) return `Cliente cadastrado com sucesso!`;

            // padrão: subtituir mensagens de validação em inglês comuns por versão em PT
            let out = s.replace(/This field is required\.?/ig, 'Este campo é obrigatório.');
            out = out.replace(/Enter a valid email address\.?/ig, 'Digite um endereço de e-mail válido.');

            return out;
        }

        // Toast helper (simple) — as mensagens passadas aqui são traduzidas antes de exibir
        function showToasts(messages, type = 'info', redirectAfterMs = 2200) {
            if (!messages || messages.length === 0) return;
            const container = document.querySelector('.toast-container') || (function(){ const c = document.createElement('div'); c.className='toast-container'; document.body.appendChild(c); return c; })();
            const translated = Array.isArray(messages) ? messages.map(m => translateMessage(typeof m === 'string' ? m : (m.text || m))) : [translateMessage(messages)];
            translated.forEach((m, i) => {
                const toast = document.createElement('div');
                toast.className = 'toast ' + (type === 'error' ? 'error' : (type === 'success' ? 'success' : 'info'));
                toast.textContent = m;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 40 + i*120);
                setTimeout(() => { toast.classList.remove('show'); setTimeout(()=>toast.remove(), 260); }, redirectAfterMs + i*420);
            });
        }

        function fecharModal() {
            if (modal) modal.style.display = 'none';
            if (form && typeof form.reset === 'function') form.reset();
            if (form) form.action = '';
            const errorLists = form ? form.querySelectorAll('.errorlist') : [];
            errorLists.forEach(ul => ul.remove());
        }

        function fecharModalExcluir() {
            if (modalExcluir) modalExcluir.style.display = 'none';
            if (formExcluir) formExcluir.action = '';
        }

        // Abrir modal de cadastro
        const btnCad = document.getElementById('abrirModalCadastrar');
        if (btnCad) btnCad.addEventListener('click', function() {
            ensureFormFields();
            if (modalTitle) modalTitle.textContent = 'Cadastrar Cliente';
            if (form) form.action = urlCadastrar;
            const errorLists = form ? form.querySelectorAll('.errorlist') : [];
            errorLists.forEach(ul => ul.remove());
            if (form && typeof form.reset === 'function') form.reset();
            if (modal) modal.style.display = 'block';
        });

        // Botões de alterar
        document.querySelectorAll('.btn-alterar').forEach(btn => btn.addEventListener('click', function(){
            const id = this.dataset.id; const nome = this.dataset.nome || ''; const email = this.dataset.email || ''; const telefone = this.dataset.telefone || ''; const saldo = this.dataset.saldo || '';
            ensureFormFields();
            if (modalTitle) modalTitle.textContent = 'Editar Cliente';
            if (form) {
                const inNome = form.querySelector('[name="nome"]');
                const inEmail = form.querySelector('[name="email"]');
                const inTelefone = form.querySelector('[name="telefone"]');
                const inSaldo = form.querySelector('[name="saldo"]');
                if (inNome) inNome.value = nome;
                if (inEmail) inEmail.value = email;
                if (inTelefone) inTelefone.value = telefone;
                if (inSaldo) inSaldo.value = saldo;
                form.action = urlEditarBase.replace('/0/', '/' + id + '/');
            }
            if (modal) modal.style.display = 'block';
        }));

        // Botões de excluir
        document.querySelectorAll('.btn-excluir').forEach(btn => btn.addEventListener('click', function(){
            const id = this.dataset.id; const nome = this.dataset.nome || '';
            const nEl = document.getElementById('nomeClienteExcluir'); if (nEl) nEl.textContent = nome;
            if (formExcluir) formExcluir.action = urlExcluirBase.replace('/0/', '/' + id + '/');
            if (modalExcluir) modalExcluir.style.display = 'block';
        }));

        // Fecha modais ao clicar fora
        window.addEventListener('click', function(event){ if (event.target === modal) fecharModal(); if (event.target === modalExcluir) fecharModalExcluir(); });

        // Intercepta submit com fetch
        if (form) form.addEventListener('submit', function(e){
            e.preventDefault();
            const action = form.action || urlCadastrar; const formData = new FormData(form);
            const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
            const csrfToken = csrfInput ? csrfInput.value : null;
            fetch(action, {
                method: 'POST', body: formData, headers: csrfToken ? { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' } : { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => { if (response.redirected) { window.location.href = response.url; return null; } return response.text(); })
            .then(text => {
                if (!text) return;
                try {
                    const parser = new DOMParser(); const doc = parser.parseFromString(text, 'text/html');
                    const returnedMessages = doc.querySelectorAll('.messages .message');
                    if (returnedMessages && returnedMessages.length) {
                        const msgs = Array.from(returnedMessages).map(m => m.textContent.trim()).filter(Boolean);
                        showToasts(msgs, 'info');
                        setTimeout(()=> window.location.href='/', 1200);
                        return;
                    }
                    const errorLists = doc.querySelectorAll('.errorlist');
                    if (errorLists && errorLists.length) {
                        const msgs = Array.from(errorLists).map(ul => ul.textContent.trim()).filter(Boolean);
                        showToasts(msgs.length ? msgs : ['Erros de validação'], 'error');
                        return;
                    }
                    const novoForm = doc.getElementById('clienteForm'); if (novoForm) { form.innerHTML = novoForm.innerHTML; ensureFormFields(); return; }
                    window.location.reload();
                } catch(e) { console.error(e); window.location.reload(); }
            })
            .catch(err => { console.error('Erro na requisição:', err); window.location.reload(); });
        });

        // Intercepta submit do formExcluir (exclusão)
        if (formExcluir) formExcluir.addEventListener('submit', function(e){
            // allow normal POST (not intercepted) or intercept similarly
            // we'll let it submit normally so Django handles redirect
        });

        // Show server-rendered messages as toasts on initial load
        (function initialMessages(){
            const msgEls = document.querySelectorAll('.messages .message');
            if (!msgEls || msgEls.length === 0) return;
            const msgs = Array.from(msgEls).map(m => m.textContent.trim()).filter(Boolean);
            if (msgs.length) showToasts(msgs, 'info');
        })();

        // Backend flags: markers to reopen modals when template rendered with errors
        if (document.getElementById('reabrir_cadastro')) {
            ensureFormFields();
            if (modalTitle) modalTitle.textContent = 'Cadastrar Cliente';
            if (form) form.action = urlCadastrar;
            if (modal) modal.style.display = 'block';
        }
        const elReabrirEdicao = document.getElementById('reabrir_edicao');
        if (elReabrirEdicao) {
            const pk = elReabrirEdicao.getAttribute('data-pk');
            if (pk) {
                ensureFormFields();
                if (modalTitle) modalTitle.textContent = 'Editar Cliente';
                if (form) form.action = urlEditarBase.replace('/0/', '/' + pk + '/');
                if (modal) modal.style.display = 'block';
            }
        }
    </script>
    </body>
    </html>